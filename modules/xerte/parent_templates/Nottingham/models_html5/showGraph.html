<script type="text/javascript">
    /**
     * Licensed to The Apereo Foundation under one or more contributor license
     * agreements. See the NOTICE file distributed with this work for
     * additional information regarding copyright ownership.

     * The Apereo Foundation licenses this file to you under the Apache License,
     * Version 2.0 (the "License"); you may not use this file except in
     * compliance with the License. You may obtain a copy of the License at:
     *
     * http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.

     * See the License for the specific language governing permissions and
     * limitations under the License.
     */

    // pageChanged & sizeChanged functions are needed in every model file
    // other functions for model should also be in here to avoid conflicts
    var showGraph = new function() {

        this.loadJS = function() {
            if (numLoaded < 1) {
                var fileToLoad;
                if (numLoaded == 0) {
                    fileToLoad = "common_html5/js/chart.min.js";
                }
                $.getScript(x_templateLocation + fileToLoad)
                        .done(function(script, textStatus) {
                            numLoaded++;
                            showGraph.loadJS();
                        })
                        .fail(function( jqxhr, settings, exception ) {
                            console.log("Failed to load chart scripts");
                        });
            }
        };

        // function called every time the page is viewed after it has initially loaded
        this.pageChanged = function() {

        }

        // function called every time the size of the LO is changed
        this.sizeChanged = function() {

        }

        this.createDiagram = function(data) {
            var importData = data;
            var numSubmits = importData.length;
            var classvalues = [];
            var objlabel = null;
            var classnames = [];
            var lastSubmit = importData.pop();
            importData.forEach(function(obj)
            {
                if (objlabel == null) {
                    objlabel = obj.label;
                }
                for(var i = 0; i < obj.classvalues.length; i++)
                {
                    if(classvalues[i] == null) {
                        classvalues[i] = obj.classvalues[i];
                    }
                    else {
                        classvalues[i] += obj.classvalues[i];
                    }

                    if(classnames[i] == null) {
                        classnames[i] = obj.classnames[i];
                    }

                }
            });
            for(var x = 0; x < classvalues.length; x++)
            {
                classvalues[x] = classvalues[x]/numSubmits;
            }
            function hexToRgb(hex, opa) {
                var bigint = parseInt(hex, 16);
                var r = (bigint >> 16) & 255;
                var g = (bigint >> 8) & 255;
                var b = bigint & 255;

                return "rgba(" + r + "," + g + "," + b + "," + opa + ")";
            }
            var ctx = $("#diagram");
            var bgColourIn = "0x000000";
            if (x_currentPageXML.getAttribute("colour") != null) {
                bgColourIn = x_currentPageXML.getAttribute("colour");
            }
            var bgColour = hexToRgb(bgColourIn.substr(bgColourIn.length - 6), 0.5);
            var lnColour = hexToRgb(bgColourIn.substr(bgColourIn.length - 6), 1);

            if (lastSubmit == null) {
                var myRadarChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: classnames,
                        datasets: [{
                            label: objlabel,
                            data: classvalues,
                            backgroundColor: bgColour,
                            borderColor: lnColour
                        }]
                    },
                    options: {
                        scale: {
                            ticks: {
                                suggestedMin: 0,
                                suggestedMax: 100
                            }
                        }
                    }
                });
            }
            else {
                var myRadarChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: classnames,
                        datasets: [{
                            label: objlabel,
                            data: classvalues,
                            backgroundColor: bgColour,
                            borderColor: lnColour
                        },
                            {
                                label: lastSubmit.label,
                                data: lastSubmit.classvalues,
                                backgroundColor: bgColour,
                                borderColor: lnColour
                            }]
                    },
                    options: {
                        scale: {
                            ticks: {
                                suggestedMin: 0,
                                suggestedMax: 100
                            }
                        }
                    }
                });
            }


        }
        this.init = function() {
            var $pageContents = $("#pageContents");
            XTGetInteractionScore(null, null, null, null, x_currentPageXML.getAttribute("import"), function(data) {
                showGraph.createDiagram(data);
            });


            // call this function in every model once everything's loaded
            x_pageLoaded();
        }
    }

    showGraph.init();

</script>



<div id="pageContents">
    <canvas id="diagram" aria-live="polite"></canvas>
</div>
