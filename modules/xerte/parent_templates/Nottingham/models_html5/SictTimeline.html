<link title="timeline-styles" rel="stylesheet" href="https://cdn.knightlab.com/libs/timeline3/latest/css/timeline.css">

<script type="text/javascript">

	// NEW PAGE MODELS SHOULD BE BASED ON THIS TEMPLATE
	// ------------------------------------------------
	// change lines 10 and 28 below so that "pageName" matches the unique name of the page in the xwd
	// save this file to models_html5 as pageName.html

	// pageChanged & sizeChanged functions are needed in every model file
	// other functions for model should also be in here to avoid conflicts
	var SictTimeline = new function() {

		var counter = 0;
		var img = []
		this.loadJS = function () {

			$('<link/>', {
				rel: 'stylesheet',
				type: 'text/css',
				href:  x_templateLocation + 'common_html5/js/timeline/timeline3.css'
			}).appendTo('head');

			if (numLoaded < 1) {
				var fileToLoad;
				if (numLoaded == 0) {
					fileToLoad = x_templateLocation + 'common_html5/js/timeline/timeline3.js';
				}

				$.getScript(fileToLoad)
						.done(function(script, textStatus) {
							numLoaded++;
							SictTimeline.loadJS();
						})
						.fail(function( jqxhr, settings, exception ) {
							console.log('Failed to load chart scripts');
						});

			}else{
				this.setup();

			}
		}

		this.setup = function (){

			var make_the_json = {
				title: {
					media: {
						url: x_currentPageXML.getAttribute("url"),
						caption: x_currentPageXML.getAttribute("tip"),
					},
					text: {
						headline: x_currentPageXML.getAttribute("name"),
						text: '<p>' + x_currentPageXML.getAttribute("text") +'</p>'
					}
				},
				events: $(x_currentPageXML).children().map(function (index, element) {
					var startDate = element.getAttribute("date");
					var endDate = element.getAttribute("endDate");




					if(startDate === "Choose Date" || startDate === null || startDate === undefined){
						var now     = new Date();
						var year    = now.getFullYear();
						var month   = now.getMonth()+1;
						var day     = now.getDate();

						if(month.toString().length === 1) {
							month = '0'+month;
						}
						if(day.toString().length === 1) {
							day = '0'+day;
						}
						var dateTime = year+'/'+month+'/'+day;
						startDate = dateTime
					}

					// if(endDate === "Choose Date" || endDate === null || endDate === undefined){
					// 	endDate = startDate
					// }

					var startTime = element.getAttribute("time");
					var endTime = element.getAttribute("endTime")

					var validStart = /^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$/.test(startTime)
					var validEnd = /^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$/.test(endTime)

					// if(startTime === null || !validStart){
					// 	startTime = "00:00"
					// }
					if(endTime === null || !validEnd){
						endTime = "00:00"
					}
					if(endDate === null || endDate === undefined){
						endDate = startDate
					}
					if(startTime === null || !validStart){
						return {
							media: {
								url: element.getAttribute("url"),
								caption: element.getAttribute("tip"),
							},
							start_date: {
								month: startDate.substring(5, 7),
								day: startDate.substring(8, 10),
								year: startDate.substring(0, 4),
							},
							end_date:{
								month: endDate.substring(5, 7),
								day: endDate.substring(8, 10),
								year: endDate.substring(0, 4),
							},
							text: {
								headline: element.getAttribute("name"),
								text: element.getAttribute("text")
							}
						}
					}else{
						return {
							media: {
								url: element.getAttribute("url"),
								caption: element.getAttribute("tip"),
							},
							start_date: {
								month: startDate.substring(5, 7),
								day: startDate.substring(8, 10),
								year: startDate.substring(0, 4),
								hour: startTime.substring(0, 2),
								minute: startTime.substring(3,5)
							},
							end_date:{
								month: endDate.substring(5, 7),
								day: endDate.substring(8, 10),
								year: endDate.substring(0, 4),
								hour: endTime.substring(0, 2),
								minute: endTime.substring(3, 5)
							},
							text: {
								headline: element.getAttribute("name"),
								text: element.getAttribute("text")
							}
						}
					}

				}).get()
			};
			var timeline_json = make_the_json; // replace make_the_json() with the JSON object you created
			// two arguments: the id of the Timeline container (no '#')
			// and the JSON object or an instance of TL.TimelineConfig created from
			// a suitable JSON object
			// var languages = ["af","ar","hy","eu","be","bg","ca","zh-cn","hr","cz","da","nl","en","en-24hr","eo","et","fo","fa","fi","fr","fy","gl","ka","de","el"
			// 	,"he","hi","hu","is","id","ga","it","ja","ko","lv","lt","lb","ms","ne","no","pl","pt","pt-br","ro","rm","ru","sr-cy","sr","si","sk","sl","es","sv"
			// 	,"tl","ta","zh-tw","te","th","tr","uk"]
			var language =  x_currentPageXML.getAttribute("language")
			// var listitem = ""
			// for(var i= 0; i < languages; i++){
			// 	if(i === language){
			// 		listitem = i
			// 	}
			// }
			if(language === null || language === ""){
				language = "English"
			}
			var lan = getCountrycode(language)
			var additionalOptions = {
				font:null,
				language:lan
			}

			window.timeline = new TL.Timeline('timeline-embed', timeline_json, additionalOptions);

			setTimeout(function (){

				$('.tl-slidenav-next').click(function (){
					debugger
					counter++
					var imgPath = img[counter].src
					var youtube = false
					if(imgPath!== undefined && imgPath!== null){
						youtube = imgPath.includes("youtube")
					}
					$('.tl-media-content').unwrap();
					if(imgPath !== "" && !youtube){
						debugger
						$('.tl-media-content').wrap('<a data-featherlight="image" href="' + imgPath + '" class="lightboxWrapper">');
					}
					var margT = $('.tl-media-item ')[counter].outerWidth(true) - $('.tl-media-item ')[counter].outerWidth();
					$('.tl-caption').css("marginLeft", margT/2)
					$('.tl-caption').css("width", margT/2)

					SictTimeline.resizeImg();

				})

				$('.tl-slidenav-previous').click(function (){

					counter--
					var imgPath = img[counter].src
					if(imgPath !== "" && !imgPath.includes("youtube")){
						$('.tl-media-content').wrap('<a data-featherlight="image" href="' + imgPath + '" class="lightboxWrapper">');
					}else{
						$('.tl-media-content').unwrap();
					}
					SictTimeline.resizeImg();

				})
				 SictTimeline.resizeImg();
				$('.spinnerHolder').remove();
				$('.tl-media-content').wrap('<a data-featherlight="image" href="' + img[0].src + '" class="lightboxWrapper">');
			}, 3000);

		}

		// function called every time the page is viewed after it has initially loaded
		this.pageChanged = function() {

			setTimeout(function (){
				SictTimeline.resizeImg();
			}, 100);
		}

		// function called every time the size of the LO is changed
		this.sizeChanged = function() {

			SictTimeline.resizeImg();

		}



		this.init = function() {
			numLoaded = 0;
			this.loadJS();
			$('#x_pageHolder').append('<div class="spinnerHolder"></div>')
			$('.spinnerHolder').append('<div class="spinner"></div>')

			var imgMaxW = Math.round($x_pageHolder.width());
			var imgMaxH = Math.round($x_pageHolder.height());

			$('.spinnerHolder').css({
				'background-color' : 'grey',
				'position' : 'absolute',
				'width': imgMaxW,
				'height': imgMaxH,
				'top' : 0,
				'z-index': 100,
				'opacity': 0.5

			})
			setTimeout(function (){

				var str = x_currentPageXML.getAttribute("error")
				$('.tl-message-content').html(str)

			}, 100);

			// call this function in every model once everything's loaded
			x_pageLoaded();

		}

		this.resizeImg = function() {
			var imgMaxW, imgMaxH;

			var pageHeight = $x_pageHolder.height()
			var pageWidth = $x_pageHolder.width()
			var pageMarginRight = $x_mainHolder.css("marginRight")
			pageMarginRight = parseInt( pageMarginRight.slice(0,  pageMarginRight.length - 2));
			var pageMarginLeft = $x_mainHolder.css("marginLeft")
			pageMarginLeft = parseInt( pageMarginLeft.slice(0,  pageMarginLeft.length - 2));
			var header = $x_headerBlock.height()
			var footer = $x_footerBlock.height()

			var totalPageWidth = pageWidth + pageMarginLeft + pageMarginRight

			if( pageMarginRight !== 0 && pageMarginLeft !==0 && footer !== 0){
				var footerHeight = $x_footerBlock.height();
				var footerMarginHeight = $('#x_footerBlock').css('marginBottom')
				footerMarginHeight = parseInt( footerMarginHeight.slice(0,  footerMarginHeight.length - 2));

				footerHeight+= footerMarginHeight
				if(header === 0){
					footerHeight+= 96
				}

				var top = pageHeight -  footerHeight
				$(".tl-timenav").css("top", top)


			}else{
				$(".tl-timenav").css("top", "auto")
			}
			imgMaxW = Math.round($x_pageHolder.width() * 0.55 - 20);
			imgMaxH = Math.round($x_pageHolder.height() - 50);

			var big;
			var normal;
			var small;
			var arrow;
			debugger
			img = document.getElementsByClassName("tl-media-item")

			big = imgMaxH*0.7
			normal = imgMaxH*0.6
			small = imgMaxH*0.4
			arrow = small*0.5
			big = big.toString()
			normal = normal.toString()
			small = small.toString()
			arrow = arrow.toString()



			for(var i =0; i < img.length; i++){
				if(img[i].src !== ""){

					//document.getElementById("timeline-embed").style = "height: " + height + "px !important;"
					//document.getElementsByClassName("tl-storyslider").style = "height: " + imgMaxH + "px !important;"
					$("#timeline-embed").css("height", big)
					$(".tl-storyslider").css("height", big)
					$(".tl-media-content-container").css("height", small)
					$(".tl-media").css("height", small)
					$(".tl-media-content").css("height", small)

					//arrow ajustment
					$(".tl-slidenav-next").css("top", arrow)


					img[i].style = "max-height: "+normal+"px; !important"
					img[i].style = "max-width: "+normal+"px; !important"
				}else{
					$("#timeline-embed").css("height", big)
					$(".tl-storyslider").css("height", big)
					$(".tl-media-content-container").css("height", small)
					$(".tl-media").css("height", small)
					$(".tl-media-content").css("height", small)

					//arrow ajustment
					$(".tl-slidenav-next").css("top", arrow)

					img[i].style = "max-height: "+small +"px; !important"
					img[i].style = "width: 30%; !important"
				}

			}


			var margT = $('.tl-media-item ').outerWidth(true) - $('.tl-media-item ').outerWidth();
			$('.tl-caption').css("marginLeft", margT/2)
			$('.tl-caption').css("width", margT/2)

			var heightTimeLine = $('.tl-timenav').height()
			heightTimeLine= heightTimeLine/3
			var top = imgMaxH-heightTimeLine
			$('.tl-menubar').css("top", top)

			$('.tl-headline-date').css({
				"padding-left" : 0,
				"padding-top" : 20,
				"padding-bottom" : 10
			})


		};

		var isoCountries = {

			'Afrikaans' : 'af',
			'Afrikaans' : 'ar',
			'Armenian' : 'hy',
			'Basque' : 'eu',
			'Belarusian' : 'be',
			'Bulgarian' : 'bg',
			'Catalan' : 'ca',
			'Chinese' : 'zh-cn',
			'Croatian/Hrvatski' : 'hr',
			'Czech' : 'cz',
			'Danish' : 'da',
			'Dutch' : 'nl',
			'English' : 'en',
			'Esperanto' : 'eo',
			'Estonian' : 'et',
			'Faroese' : 'fo',
			'Farsi' : 'fa',
			'Finnish' : 'fi',
			'French' : 'fr',
			'Frisian' : 'fy',
			'Galician' : 'gl',
			'Georgian' : 'ka',
			'German' : 'de',
			'Greek' : 'el',
			'Hebrew' : 'he',
			'Hindi' : 'hi',
			'Hungarian' : 'hu',
			'Icelandic' : 'is',
			'Indonesian' : 'id',
			'Irish' : 'ga',
			'Italian' : 'it',
			'Japanese' : 'ja',
			'Korean' : 'ko',
			'Latvian' : 'lv',
			'Lithuanian' : 'lt',
			'Luxembourgish' : 'lb',
			'Malay' : 'ms',
			'Nepali' : 'ne',
			'Norwegian' : 'no',
			'Polish' : 'pl',
			'Portuguese' : 'pt',
			'Portuguese (Brazilian)' : 'pt-br',
			'Romanian' : 'ro',
			'Romansh' : 'rm',
			'Russian' : 'ru',
			'Serbian - Cyrillic' : 'sr-cy',
			'Serbian - Latin' : 'sr',
			'Sinhalese' : 'si',
			'Slovak' : 'sk',
			'Slovenian' : 'sl',
			'Spanish' : 'es',
			'Swedish' : 'sv',
			'Tagalog' : 'tl',
			'Tamil' : 'ta',
			'Taiwanese' : 'zh-tw',
			'Telugu' : 'te',
			'Thai' : 'th',
			'Turkish' : 'tr',
			'Ukrainian' : 'uk'
		};

		function getCountrycode (countryName) {

			if (isoCountries.hasOwnProperty(countryName)) {
				return isoCountries[countryName];
			} else {
				return countryName;
			}
		}

	}



	SictTimeline.init();

</script>


<style type="text/css">

</style>


<div id="pageContents">
	<div id='timeline-embed' style="width: 100%; height: 500px"></div>
</div>
